<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Design Review Planner</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/primeicons/primeicons.css">

  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background:#f5f5f5; margin:0; padding:12px; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    h1 { margin:0; font-size:20px; }
    button { padding:8px 12px; border-radius:8px; border:none; background:#222; color:#fff; cursor:pointer; }
    .secondary { background:#eee; color:#333; font-size:12px; }
    .cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:16px; }
    .card { background:#fff; border-radius:14px; padding:16px; box-shadow:0 4px 12px rgba(0,0,0,.08); display:flex; flex-direction:column; gap:12px; }

    .card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }

    .slot { background:#eee; border-radius:10px; padding:12px; cursor:pointer; position:relative; }
    .slot.occupied { background:#f0f9f5; }
    .slot-time { font-size:12px; color:#666; }
    .slot-name { font-weight:600; }
    .delete { position:absolute; top:8px; right:8px; cursor:pointer; }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; justify-content:center; align-items:flex-end; padding:12px; }
    .modal.open { display:flex; }
    .modal-content { background:#fff; width:100%; max-width:480px; border-radius:16px 16px 0 0; padding:20px; }

    input, textarea, select {
      width:100%;
      padding:8px;
      margin-bottom:8px;
      border-radius:6px;
      border:1px solid #ccc;
    }

    .slot-editor-row {
      display:flex;
      gap:8px;
      margin-bottom:6px;
    }
  </style>
</head>

<body>

<header>
  <h1>Design Review</h1>
  <button>Historie</button>
</header>

<div id="todayInfo"></div>
<div class="cards" id="cards"></div>

<!-- MODAL slot -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Přihlášení na slot</h3>
    <input id="inputName" placeholder="Jméno" />
    <input id="inputTeam" placeholder="Tým" />
    <input id="inputJourney" placeholder="Název cesty" />
    <select id="inputSegment">
      <option value="">Segment</option>
      <option value="SMB">SMB</option>
      <option value="Retail">Retail</option>
    </select>
    <textarea id="inputNote" placeholder="Poznámka"></textarea>
    <button id="saveBtn">Uložit</button>
  </div>
</div>

<!-- MODAL slot config -->
<div class="modal" id="slotsConfigModal">
  <div class="modal-content">
    <h3>Upravit sloty</h3>
    <div id="slotsEditor"></div>
    <button class="secondary" id="addSlotBtn">+ Přidat slot</button>
    <br><br>
    <button id="saveSlotsConfig">Uložit změny</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "TVŮJ_API_KEY",
  authDomain: "design-review-data.firebaseapp.com",
  projectId: "design-review-data"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const defaultSlots = ["13:05 – 13:45","13:45 – 14:25","14:35 – 15:15","15:15 – 15:55"];
let activeSlot = null;
let activeDateForSlots = null;

const inputName = inputName = document.getElementById("inputName");
const inputTeam = document.getElementById("inputTeam");
const inputJourney = document.getElementById("inputJourney");
const inputSegment = document.getElementById("inputSegment");
const inputNote = document.getElementById("inputNote");
const modal = document.getElementById("modal");

document.getElementById("todayInfo").textContent =
  "Dnes je: " + new Date().toLocaleDateString("cs-CZ", {
    weekday:"long", day:"numeric", month:"long", year:"numeric"
  });

function getNextWednesday(d){
  d=new Date(d);
  d.setDate(d.getDate()+(3-d.getDay()+7)%7);
  return d;
}

async function renderCards(){
  const container=document.getElementById("cards");
  container.innerHTML="";

  const snapshot = await db.collection("slots").get();
  const slotsFromDb = {};
  snapshot.forEach(doc => slotsFromDb[doc.id] = doc.data());

  let day=getNextWednesday(new Date());

  for(let i=0;i<4;i++){
    const dateStr=day.toLocaleDateString("cs-CZ",{weekday:"long",day:"numeric",month:"long"});

    const configDoc = await db.collection("slots-config").doc(dateStr).get();
    const slots = configDoc.exists ? configDoc.data().slots : defaultSlots;

    const card=document.createElement("div");
    card.className="card";

    const header=document.createElement("div");
    header.className="card-header";
    header.innerHTML = `<strong>${dateStr}</strong>`;
    const editBtn=document.createElement("button");
    editBtn.textContent="Upravit sloty";
    editBtn.className="secondary";
    editBtn.onclick=()=>openSlotsConfig(dateStr, slots);
    header.appendChild(editBtn);
    card.appendChild(header);

    slots.forEach(time=>{
      const slot=document.createElement("div");
      slot.className="slot";
      slot.dataset.time=time;

      const docId = dateStr + " " + time;
      if (slotsFromDb[docId]) slot.data = slotsFromDb[docId];

      renderSlot(slot);

      slot.onclick = e => {
        if (e.target.closest(".delete")) return;
        activeSlot = slot;
        fillForm(slot);
        modal.classList.add("open");
      };

      card.appendChild(slot);
    });

    container.appendChild(card);
    day.setDate(day.getDate()+7);
  }
}

function renderSlot(slot){
  if(!slot.data){
    slot.classList.remove("occupied");
    slot.innerHTML = `<div class="slot-time">${slot.dataset.time}</div>`;
    return;
  }

  const d=slot.data;
  slot.classList.add("occupied");
  slot.innerHTML = `
    <div class="delete"><i class="pi pi-trash"></i></div>
    <div class="slot-time">${slot.dataset.time}</div>
    <div class="slot-name">${d.name}</div>
    <div class="slot-meta">${d.team} · ${d.journey}</div>
    <span>${d.segment}</span>
  `;

  slot.querySelector(".delete").onclick = async e => {
    e.stopPropagation();
    if(confirm("Opravdu chcete smazat přihlášku?")){
      const docId = slot.closest(".card").querySelector("strong").textContent + " " + slot.dataset.time;
      await db.collection("slots").doc(docId).delete();
      slot.data=null;
      renderSlot(slot);
    }
  };
}

function fillForm(slot){
  const d=slot.data||{};
  inputName.value=d.name||"";
  inputTeam.value=d.team||"";
  inputJourney.value=d.journey||"";
  inputSegment.value=d.segment||"";
  inputNote.value=d.note||"";
}

document.getElementById("saveBtn").onclick = async ()=>{
  if(!activeSlot) return;
  const date = activeSlot.closest(".card").querySelector("strong").textContent;
  const data={
    name:inputName.value,
    team:inputTeam.value,
    journey:inputJourney.value,
    segment:inputSegment.value,
    note:inputNote.value,
    time:activeSlot.dataset.time,
    date
  };
  await db.collection("slots").doc(date+" "+data.time).set(data);
  activeSlot.data=data;
  renderSlot(activeSlot);
  modal.classList.remove("open");
};

function openSlotsConfig(date, slots){
  activeDateForSlots = date;
  const editor=document.getElementById("slotsEditor");
  editor.innerHTML="";
  slots.forEach(s=>{
    const row=document.createElement("div");
    row.className="slot-editor-row";
    row.innerHTML=`<input value="${s}"><button class="secondary">✕</button>`;
    row.querySelector("button").onclick=()=>row.remove();
    editor.appendChild(row);
  });
  document.getElementById("slotsConfigModal").classList.add("open");
}

document.getElementById("addSlotBtn").onclick=()=>{
  const row=document.createElement("div");
  row.className="slot-editor-row";
  row.innerHTML=`<input placeholder="14:00 – 14:30"><button class="secondary">✕</button>`;
  row.querySelector("button").onclick=()=>row.remove();
  document.getElementById("slotsEditor").appendChild(row);
};

document.getElementById("saveSlotsConfig").onclick=async()=>{
  const slots=[...document.querySelectorAll("#slotsEditor input")]
    .map(i=>i.value).filter(Boolean);
  await db.collection("slots-config").doc(activeDateForSlots).set({slots});
  document.getElementById("slotsConfigModal").classList.remove("open");
  renderCards();
};

document.getElementById("modal").onclick = e => {
  if(e.target.id==="modal") e.target.classList.remove("open");
};

renderCards();
</script>

</body>
</html>
